{% extends "admin_base.html" %}

{% block title %}WoTT - Credentials{% endblock title %}

{% block dashboard_title %}
  <h1>Credentials</h1>
{% endblock dashboard_title %}

{% block admin_content %}

  <div class="modal show fade" tabindex="-1" role="dialog" id="mymodal">
    <div class="modal-dialog modal-xl" role="document">
      <form class="modal-content" id="wott-cred-form" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title-h2">Add New Credential</h2>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="name">Name</label>
                <input type="text" class="form-control" id="name" placeholder="Name" name="name">
              </div>
              <div class="form-group col-md-4">
                <label for="key">Key</label>
                <input type="text" class="form-control" id="key" placeholder="Key" name="key">
              </div>
              <div class="form-group col-md-4">
                <label for="value">Value</label>
                <input type="text" class="form-control" id="value" placeholder="Value" name="value">
              </div>
              <input type="hidden" name="pk" id="pk">
            </div>

            <div class="alert alert-warning wott-form-alert p-1" role="alert">
              A simple warning alert—check it out!
            </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">Credentials</h5>
            <h6 class="card-subtitle text-muted">View credentials.</h6>
          </div>
          <div class="card-body">
            <table id="datatables-basic" class="table table-striped table-responsive-xs" style="width:100%">
              <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Value</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
  </div>
{#  <div class="row">#}
  <button type="button" class="btn btn-success" id="wott-add-creds-btn">＋ Add Credential</button>
{#  </div>#}

{% endblock admin_content %}

{% block scripts %}
  <style>
  .btn {
    color: white;
  }
  .wott-form-alert {
    color: black;
    display: none;
  }
  td.wott-cred-btns .btn {
    visibility: hidden;
  }
  #datatables-basic tr:hover td.wott-cred-btns .btn {
    visibility: visible;
  }
  </style>
  <script>

    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    var table;
    document.addEventListener("DOMContentLoaded", function () {
      // Datatables basic
      table = $('#datatables-basic').DataTable({
        responsive: true,
        ajax: '/ajax/creds',
        columns: [
            {'data': 'name'},
            {'data': 'key'},
            {'data': 'value'},
        ],
        rowId: 'pk',
        columnDefs: [ {
          targets: 3,
          orderable: false,
          data: null,
          className: 'wott-cred-btns',
          defaultContent: "<button class='btn btn-success wott-creds-edit-btn'>Edit</button> <button class='btn btn-danger'>Remove</button>"
        } ]
      });
    });

    function showDialog(header, data) {
      $('#modal-title-h2')[0].innerText = header;

      if(data) {
          for(let k in data) {
            document.getElementById(k).value = data[k];
          }
      } else {
          for(let k of ['key', 'name', 'value', 'pk']) {
              document.getElementById(k).value = '';
          }
      }

      $('.wott-form-alert')[0].style.display = 'none';
      $('#mymodal').modal('toggle')
    }

    $('#wott-cred-form').submit(function (e) {
          e.preventDefault();
          $.post('/credentials/', $('form').serialize(), function () {
              $('#mymodal').modal('toggle');
              table.ajax.reload();
          }).done(function() {
              console.log('success');
          }).fail(function(a) {
              console.log('error');
              console.log(a.status, a.responseText);
              alertbox = $('.wott-form-alert')[0];
              alertbox.style.display = 'block';
              if(a.status == 400)
                alertbox.innerText = a.responseText;
          });
      });

    $('#datatables-basic tbody').on( 'click', '.wott-creds-edit-btn', function () {
        let data = table.row( $(this).parents('tr') ).data();
        showDialog("Edit Credential", data);
    } );
    $('#wott-add-creds-btn').on('click', function () {
        showDialog("Add Credential");
    })
  </script>
{% endblock scripts %}