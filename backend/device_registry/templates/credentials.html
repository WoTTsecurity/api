{% extends "admin_base.html" %}

{% block css %}
    {{ form_media.css }}
    <style type="text/css">
      /* tagulous tags styling */
    .select2-container-multi .select2-choices .select2-search-choice {
      background-color: #256164;
      background-image: linear-gradient(0.25turn, #f5f9fc, #f5f9fc);
      /*background-image: linear-gradient(0.25turn, #3f87a6, #ebf8e1)*/
    }
    .select2-container-multi.select2-container-disabled {
      width: 100%;
    }
    .select2-container-multi.select2-container-disabled .select2-choices .select2-search-choice{
      /*background-image: linear-gradient(0.25turn, #3f87a6, #ebf8e1)*/
      background-image: linear-gradient(0.25turn, #f5f9fc, #f5f9fc);
    }
    .select2-container.select2-container-multi.form-control {
      padding: 0 !important;
    }
    input[failed]{
      border-color: red;
    }

    </style>
{% endblock %}
{% block js %}
    {{ form_media.js }}
{% endblock %}

{% block title %}WoTT - Credentials{% endblock title %}

{% block dashboard_title %}
  <h1>Credentials</h1>
    <style>
        .input-with-icon #value{
            padding-left: 40px;
        }

        .input-with-icon{
            position: relative;
        }

        .input-with-icon i{
            position: absolute;
            left: 8px;
            top: 32px;
            padding: 9px 8px;
            color: #aaa;
            transition: .3s;
        }

        .input-with-icon svg{
            position: relative;
            left: 8px;
            top: -26px;
            color: #aaa;
            transition: .3s;
            focusable: true;
        }
    </style>

{% endblock dashboard_title %}

{% block admin_content %}

  <div class="modal show fade" tabindex="-1" role="dialog" id="wott-cred-modal">
    <div class="modal-dialog modal-xl" role="document">
      <form class="modal-content" id="wott-cred-form" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title-h2">Add New Credential</h2>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="name">Name</label>
                <input type="text" class="form-control" id="name" placeholder="Name" name="name">
              </div>
              <div class="form-group col-md-6">
                <label for="key">Key</label>
                <input type="text" class="form-control" id="key" placeholder="Key" name="key">
              </div>
            </div>
            <div class="form-row">
              <div class=" input-with-icon form-group col-md-6">
                <label for="value">Value</label>
                <input type="password" class="form-control" id="value" placeholder="Value" name="value"  autocomplete="new-password">
                <i class="fa fa-eye fa-lg fa-fw" aria-hidden="true" id="value-eye" onmousedown="show_modal_values(true)"
                   onmouseup="show_modal_values(false)"></i>
              </div>
              <div class="form-group col-md-6">
                <label for="linux_user" data-toggle="tooltip" data-placement="top" title="Real linux user on your device, which would be permitted to this credential data reading. Could be blank for root as well as be root." >
                  File owner
                  <i class="fas fa-info-circle"></i>
                </label>
                <input type="text" class="form-control" id="linux_user" placeholder="Owner" name="linux_user">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tags">Tags</label>
                <input type="text" data-tagulous="true" class="form-control" id="tags" placeholder="Tags" name="tags" data-tag-url="/ajax/tags/autocomplete/"
                  data-tag-options="{&quot;force_lowercase&quot;: true, &quot;space_delimiter&quot;: true}"  autocomplete="off" >
              </div>
              <div class="form-group col-md-6">
                <label for="hardware">Hardware</label>
                <select class="form-control" id="hardware" name="hardware">
                  <option value="1">All devices</option>
                  <option value="2">Raspberry Pi</option>
                </select>
              </div>
              <input type="hidden" name="pk" id="pk">
              <input type="hidden" name="method" id="method">
            </div>

            <div class="alert alert-warning wott-form-alert p-1" role="alert" id="edit_alert">
              Server error
            </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="wott-confirm-modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Removal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="wott-del-cred-btn">Delete</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
            <div class="alert alert-warning wott-form-alert p-1" role="alert" id="del_alert">
              Server error
            </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">Credentials</h5>
            <h6 class="card-subtitle text-muted">View credentials.</h6>
          </div>
          <div class="card-body">
            <table id="datatables-basic" class="table table-striped table-responsive-xs" style="width:100%">
              <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Value</th>
                <th>Tags</th>
                <th>Hardware</th>
                <th>File owner</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
  </div>
{#  <div class="row">#}
  <button type="button" class="btn btn-success" id="wott-add-creds-btn">ï¼‹ Add Credential</button>
{#  </div>#}

{% endblock admin_content %}

{% block scripts %}
  <style>
  .btn {
    color: white;
  }
  .wott-form-alert {
    color: black;
    display: none;
  }
  td.wott-cred-btns .btn {
    visibility: hidden;
  }
  #datatables-basic tr:hover td.wott-cred-btns .btn {
    visibility: visible;
  }
  </style>
  <script>
    const del_modal_idx = 1;
    const edit_modal_idx = 0;

    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function show_modal_values(state){
        if(state) {
            $("#value-eye").css("color", "dodgerblue");
            $("#value").attr("type", "text");
        }
        else{
            $("#value").attr("type", "password");
            $("#value-eye").css( "color","#aaa");
        }
    }

    function update_popovers()
    {
        $('[data-toggle="popover"]').popover({
            trigger : "hover focus click",
            title: "Path to credentials file.",
        });

        $('[data-toggle="popover"]').on('inserted.bs.popover', function (obj) {
            $('[data-toggle="popover"]').not(this).popover('hide');
        })
    }

    $(function () {
        update_popovers();
    });

    var table;
    document.addEventListener("DOMContentLoaded", function () {
      // Datatables basic
      table = $('#datatables-basic').DataTable({
        responsive: true,
        ajax: '/ajax-creds/',
        columns: [
            {'data': 'name'},
            {'data': 'key'},
            {'data': 'value'},
            {'data': 'tags_data'},
            {'data': 'hardware_str'},
            {'data': 'linux_user'},
        ],
        language: {
          emptyTable: "No credentials added."
        },
        rowId: 'pk',
        columnDefs: [ {
          targets: 6,
          orderable: false,
          data: null,
          className: 'wott-cred-btns',
          defaultContent: "<button class='btn btn-success wott-creds-edit-btn'>Edit</button> " +
                          "<button class='btn btn-danger wott-creds-del-btn'>Remove</button>"

        }, {
          targets: 2,
          render: function(data, type, row, meta){
            if( type == "sort" ) return data;
            let stars = '*'.repeat(data.length);
            return stars;
          },

         }, {
            targets: 0,
            render: function(data, type, row, meta){
                if( type == "sort" ) return data;
                let credential_path = "{{ pi_credentials_path }}"
                    + ( row.linux_user == '' ?  "/" : "/" + row.linux_user + '/' )
                    + data + ".json";
                return "<span data-container=\"body\" data-toggle=\"popover\" data-placement=\"right\" "
                       + "data-content=\"" + credential_path + "\" >" + data + "</span>";
            }
         } ,{
            targets: 3,
            render: function(data, type, row, meta){
                if( type == "sort" ) return data;

                let value = tags_to_string(data);
                let data_tag_list = JSON.stringify(data).replace( /\"/g, "&quot;"); // data-tag-list

                return '<input type="text" data-tagulous="true"  data-tag-url="/ajax/tags/autocomplete/" value="' +
                    value + '" readonly data-tag-options="{&quot;force_lowercase&quot;: true, ' +
                    ' &quot;space_delimiter&quot;: true, &quot;required&quot;: false}" id=tags_id_' +
                    + meta.row + '" data-tag-list="' + data_tag_list + '" style="width:100%" >';
            }
         }
        ]
      });

      table.on( 'draw.dt', function () {
          Tagulous.select2($('input[id^="tags_id_"]'));
          update_popovers();
      });

    });

    function showDialog(method, header, data) {
      $('#modal-title-h2')[0].innerText = header;
      document.getElementById('method').value = method;

      if(data) {
          for(let k in data) {
              if( k == 'tags_data')
              {
                  el = $('#tags');
                  el.val(tags_to_string(data[k]));
                  Tagulous.select2(el);
              }
              else
                  $(`#${k}`).val(data[k]);
          }
      } else {
          for(let k of ['key', 'name', 'value', 'pk', 'tags']) {
              $(`#${k}`).val('');
          }
          Tagulous.select2($("#tags"));
      }

      $('.wott-form-alert')[edit_modal_idx].style.display = 'none';
      $('#wott-cred-modal').modal('toggle');
    }

    function alertbox_on_ajax_fail(a, box_idx){
        console.log('error');
        console.log(a.status, a.responseText);
        alertbox = $('.wott-form-alert')[box_idx];
        alertbox.style.display = 'block';
        if(a.status == 400 || a.status == 404 || a.status == 405) {
            errMsg = "";
            firstFailed = "";
            for (key in a.responseJSON) {
                if (firstFailed == "" && key != "detail" )
                    firstFailed = key;
                else
                    errMsg = errMsg + "\n";
                disp_key = (key == 'linux_user') ? 'owner' : key;
                errMsg = errMsg + disp_key + " : " + a.responseJSON[key];
                if ( key != "detail")
                {
                  el = $("#" + key)
                  el.attr("failed", true);
                  el.attr("onchange", "remove_failed_status(this)");
                }
            }
            alertbox.innerText = errMsg;
            $("#" + firstFailed).focus();
        }
        else alertbox.innerText = a.responseText;
    }

    $('#wott-cred-form').submit(function (e) {
          e.preventDefault();
          data = {};
          for(let item of $('form').serializeArray()) {
              data[item.name] = item.value;
          }
          let {key, name, value, pk, linux_user, hardware} = data;

          tags=[];
          Tagulous.parseTags( data.tags, true, false ).forEach( function (tag) {
             tags.push({ "name" : tag  })
          });

          let type = pk? 'PATCH': 'POST',
          url = pk? `/ajax-creds/${pk}/update/`:  `/ajax-creds/create/`;
          $.ajax({
              url,
              type,
              data: JSON.stringify({key, name, value, tags, linux_user, hardware}),
              processData: false,
              contentType: 'application/json',

          }).done(function(a) {

              console.log('success', a);
              if(a.error) {
                alertbox = $('.wott-form-alert')[edit_modal_idx];
                alertbox.style.display = 'block';
                alertbox.innerText = a.error;
                return;
              }
              $('#wott-cred-modal').modal('toggle');
              table.ajax.reload();

          }).fail( function(a) {
                  alertbox_on_ajax_fail(a, edit_modal_idx);
          });
      });

    function remove_failed_status(el){
        el = $(el);
        el.removeAttr("failed");
        el.removeAttr("onchange")
    }

    function tags_to_string(data){
        let safe=[]
        for( let tag of data ) {
            let str = tag.name.replace(/"/g, '""');
            if (!str) {
                continue;
            }
            if (str.indexOf(',') > -1 || str.indexOf(' ') > -1) {
                safe.push('"' + str + '"');
            } else {
                safe.push(str);
            }
        }
        safe.sort();
        return safe.join(', ');
    }

    $('#datatables-basic tbody').on( 'click', '.wott-creds-edit-btn', function () {
        let data = table.row( $(this).parents('tr') ).data();
        showDialog('update', "Edit Credential", data);
    } );
    $('#wott-add-creds-btn').on('click', function () {
        showDialog('create', "Add Credential");
    });

    var deleted_pk;
    $('#datatables-basic tbody').on( 'click', '.wott-creds-del-btn', function () {
        console.log('del');
        $('.wott-form-alert')[del_modal_idx].style.display = 'none';
        let data = table.row( $(this).parents('tr') ).data();
        deleted_pk = data.pk;
        $('#wott-confirm-modal').modal('toggle');
    });
    $('#wott-del-cred-btn').on('click', function () {
        console.log('del');

        $.ajax({
            url: `/ajax-creds/${deleted_pk}/delete/`,
            type: "DELETE",
        }).done(function () {
            console.log('success');
            table.ajax.reload();
            $('#wott-confirm-modal').modal('toggle');
        }).fail(function (a) {
            console.log('error');
            console.log(a.status, a.responseText);
            alertbox_on_ajax_fail(a,del_modal_idx);
        });
    });
  </script>
{% endblock scripts %}