{% extends "admin_base.html" %}

{% block css %}
    {{ form_media.css }}
{% endblock %}
{% block js %}
    {{ form_media.js }}
{% endblock %}

{% block title %}WoTT - Credentials{% endblock title %}

{% block dashboard_title %}
  <h1>Credentials</h1>
    <style>
        .input-with-icon #value{
            padding-left: 40px;
        }

        .input-with-icon{
            position: relative;
        }

        .input-with-icon i{
            position: absolute;
            left: 8px;
            top: 32px;
            padding: 9px 8px;
            color: #aaa;
            transition: .3s;
        }

        .input-with-icon svg{
            position: relative;
            left: 8px;
            top: -26px;
            color: #aaa;
            transition: .3s;
            focusable: true;
        }
    </style>

{% endblock dashboard_title %}

{% block admin_content %}

  <div class="modal show fade" tabindex="-1" role="dialog" id="wott-cred-modal">
    <div class="modal-dialog modal-xl" role="document">
      <form class="modal-content" id="wott-cred-form" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title-h2">Add New Credential</h2>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-3">
                <label for="name">Name</label>
                <input type="text" class="form-control" id="name" placeholder="Name" name="name">
              </div>
              <div class="form-group col-md-3">
                <label for="key">Key</label>
                <input type="text" class="form-control" id="key" placeholder="Key" name="key">
              </div>
              <div class=" input-with-icon form-group col-md-3">
                <label for="value">Value</label>
                <input type="password" class="form-control" id="value" placeholder="Value" name="value">
                <i class="fa fa-eye fa-lg fa-fw" aria-hidden="true" id="value-eye" onmousedown="show_modal_values(true)"
                   onmouseup="show_modal_values(false)"></i>
              </div>
              <div class="form-group col-md-3">
                <label for="value">Tags</label>
                <input type="text" data-tagulous="true" class="form-control" id="tags" placeholder="Tags" name="tags">
              </div>
              <input type="hidden" name="pk" id="pk">
              <input type="hidden" name="method" id="method">
            </div>

            <div class="alert alert-warning wott-form-alert p-1" role="alert">
              Server error
            </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="wott-confirm-modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Removal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="wott-del-cred-btn">Delete</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">Credentials</h5>
            <h6 class="card-subtitle text-muted">View credentials.</h6>
          </div>
          <div class="card-body">
            <table id="datatables-basic" class="table table-striped table-responsive-xs" style="width:100%">
              <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Value</th>
                <th>Tags</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
  </div>
{#  <div class="row">#}
  <button type="button" class="btn btn-success" id="wott-add-creds-btn">ï¼‹ Add Credential</button>
{#  </div>#}

{% endblock admin_content %}

{% block scripts %}
  <style>
  .btn {
    color: white;
  }
  .wott-form-alert {
    color: black;
    display: none;
  }
  td.wott-cred-btns .btn {
    visibility: hidden;
  }
  #datatables-basic tr:hover td.wott-cred-btns .btn {
    visibility: visible;
  }
  </style>
  <script>

    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function show_modal_values(state){
        if(state) {
            $("#value-eye").css("color", "dodgerblue");
            $("#value").attr("type", "text");
        }
        else{
            $("#value").attr("type", "password");
            $("#value-eye").css( "color","#aaa");
        }
    }
  
    $(function () {
        $('[data-toggle="popover"]').popover({
            trigger : "hover focus click",
            title: "Path to credentials file.",
        });

        $('[data-toggle="popover"]').on('inserted.bs.popover', function (obj) {
            $('[data-toggle="popover"]').not(this).popover('hide');
        })
    });

    var table;
    document.addEventListener("DOMContentLoaded", function () {
      // Datatables basic
      table = $('#datatables-basic').DataTable({
        responsive: true,
        ajax: '/ajax-creds/',
        columns: [
            {'data': 'name'},
            {'data': 'key'},
            {'data': 'value'},
            {'data': 'tags'},
        ],
        language: {
          emptyTable: "No credentials added."
        },
        rowId: 'pk',
        columnDefs: [ {
          targets: 4,
          orderable: false,
          data: null,
          className: 'wott-cred-btns',
          defaultContent: "<button class='btn btn-success wott-creds-edit-btn'>Edit</button> " +
                          "<button class='btn btn-danger wott-creds-del-btn'>Remove</button>"

        }, {
          targets: 2,
          render: function(data, type, row, meta){
            if( type == "sort" ) return data;
            let stars = '*'.repeat(data.length);
            return stars;
          },

         }, {
            targets: 0,
            render: function(data, type, row, meta){
                if( type == "sort" ) return data;
                return "<span data-container=\"body\" data-toggle=\"popover\" data-placement=\"right\" "
                       + "data-content=\"{{ pi_credentials_path }}/" + data + ".json\" >" + data + "</span>";
            }
         } ,{
            targets: 3,
            render: function(data, type, row, meta){
                debugger;
                if( type == "sort" ) return data;
                return "<input type=\"text\" data-tagulous=\"true\"  data-tag-url=\"/ajax/tags/autocomplete/\" value=\"" +
                    data + "\" readonly ></input>";

            }
         }
        ]
      });
    });

    function showDialog(method, header, data) {
      $('#modal-title-h2')[0].innerText = header;
      document.getElementById('method').value = method;

      if(data) {
          for(let k in data) {
            document.getElementById(k).value = data[k];
          }
      } else {
          for(let k of ['key', 'name', 'value', 'pk']) {
              document.getElementById(k).value = '';
          }
      }

      $('.wott-form-alert')[0].style.display = 'none';
      $('#wott-cred-modal').modal('toggle')
    }

    $('#wott-cred-form').submit(function (e) {
          e.preventDefault();
          data = {};
          for(let item of $('form').serializeArray()) {
              data[item.name] = item.value;
          }
          let {key, name, value, pk} = data;
          let type = pk? 'PATCH': 'POST',
              url = pk? `/ajax-creds/${pk}/update/`:  `/ajax-creds/create/`;

          $.ajax({
              url,
              type,
              data: JSON.stringify({key, name, value}),
              processData: false,
              contentType: 'application/json',
          }).done(function(a) {
              console.log('success', a);
              if(a.error) {
                alertbox = $('.wott-form-alert')[0];
                alertbox.style.display = 'block';
                alertbox.innerText = a.error;
                return;
              }
              $('#wott-cred-modal').modal('toggle');
              table.ajax.reload();})
            .fail(function(a) {
              console.log('error');
              console.log(a.status, a.responseText);
              alertbox = $('.wott-form-alert')[0];
              alertbox.style.display = 'block';
              if(a.status == 400)
                alertbox.innerText = a.responseText;
          });
      });

    $('#datatables-basic tbody').on( 'click', '.wott-creds-edit-btn', function () {
        let data = table.row( $(this).parents('tr') ).data();
        showDialog('update', "Edit Credential", data);
    } );
    $('#wott-add-creds-btn').on('click', function () {
        showDialog('create', "Add Credential");
    });

    var deleted_pk;
    $('#datatables-basic tbody').on( 'click', '.wott-creds-del-btn', function () {
        console.log('del');
        let data = table.row( $(this).parents('tr') ).data();
        deleted_pk = data.pk;
        $('#wott-confirm-modal').modal('toggle');
    });
    $('#wott-del-cred-btn').on('click', function () {
        console.log('del');

        $('#wott-confirm-modal').modal('toggle');
        $.ajax({
            url: `/ajax-creds/${deleted_pk}/delete/`,
            type: "DELETE",
        }).done(function () {
            console.log('success');
            table.ajax.reload();
        }).fail(function (a) {
            console.log('error');
            console.log(a.status, a.responseText);
        });
    });
  </script>
{% endblock scripts %}