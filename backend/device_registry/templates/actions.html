{% extends "admin_base.html" %}

{% block title %}WoTT - Recommended Actions{% endblock title %}

{% load static %}

{% block dashboard_title %}
  <h1>Recommended Actions{% if device_name %} for {{ device_name }}{% endif %}</h1>
{% endblock dashboard_title %}

{% block admin_content %}
  <div id="actions-tab" class="">
    <div class="overlay" style="display: none;"></div> <!--@Artem: hange class to display:block when modal is open-->
    <div class="mb-3 w-100" id="alert-container">
      {% for action in actions %}
        <div class="" role="alert">
          <div class="full-alert-box mb-3 wott-box-shadow">
            
            <div class="d-flex wott-closed-box align-items-center">
              <div class="recommendation-left-box">
                <div class="round pl-5">
                  <input type="checkbox" id="alert-ra-{{forloop.counter}}"/> <!--include checked atribute to check the input-->
                  <label for="alert-ra-{{forloop.counter}}"></label>
                </div>
                <div class="alert-box-text">
                  <div class="d-flex align-items-center justify-content-between mb-0">
                    <span class="alert-title"> <!--include solved-dash to linetrough the title when clicked-->
                      {{ action.title|safe }}
                      
                      {% if action.issue_url %}
                        <a href="{{ action.issue_url }}"><i class="fab fa-github"></i></a>
                      {% endif %}
                    </span>
                    {% with action.severity.value as action_severity %}
                    <div class="badge mr-4 mb-1 text-uppercase wott-rect-badge-{{ action_severity.1 }}">
                      {{ action_severity.0 }}
                    </div>
                    {% endwith %}
                  </div>
                  <h5 class="alert-instruction mb-0">Consider changing them as soon as possible</h5> <!--message from DB-->
                </div>
              
                
                <div class="dropdown"> <!-- @Aartem: if no details include d-none-->
                  <button id="toogle-ra" class="btn wott-btn-dropdown">VIEW DETAILS <i class=" ml-1 fas fa-sort-down"></i></button>
                </div>
              </div>
              
              {% ifnotequal action.action_id 0 %}
              <div class="btn-group-box">
                <div class="btn-group wott-alert-btn-group d-flex justify-content-around"
                    wott-action
                    wott-action-id="{{ action.action_id }}"
                    wott-action-devices="{{ action.devices }}"
                    wott-action-title="{{ action.title }}">
                  <button type="button" class="bg-white" data-dismiss="alert" wott-snooze wott-snooze-duration="0"> <!--@Artem: if btns disable include class look-disable -->
                    <span>
                      <img id="ignore-img" 
                              class="wott-img-btn" 
                              src="{% static '/media/multiply.svg' %}" 
                              data-src1="{% static '/media/multiply.svg' %}" 
                              data-src2="{% static '/media/close-selected.svg' %}" 
                              onmouseover="hover(this)" 
                              onmouseout="unhover(this)">
                    </span>
                    <div class="btn-img-text">IGNORE</div>
                  </button>
                  <button type="button" class="bg-white" data-toggle="dropdown"> <!--@Artem: if btns disable include class look-disable -->
                    <span>
                      <img id="snooze-img" 
                          class="wott-img-btn" 
                          src="{% static '/media/snooze-icon.svg' %}"
                          data-src1="{% static '/media/snooze-icon.svg' %}" 
                          data-src2="{% static '/media/snooze-selected.svg' %}" 
                          onmouseover="hover(this)" 
                          onmouseout="unhover(this)">
                    </span>
                    <div class="btn-img-text">SNOOZE</div>
                  </button>
                  <button type="button" class="bg-white" data-dismiss="alert" wott-snooze wott-snooze-duration="null"><!--@Artem: if btns disable include class look-disable -->
                    <span>
                      <img id="resolved-img"
                          class="wott-img-btn" 
                          src="{% static '/media/resolve-icon.svg' %}"
                          data-src1="{% static '/media/resolve-icon.svg' %}" 
                          data-src2="{% static '/media/resolve-selected.svg' %}" 
                          onmouseover="hover(this)" 
                          onmouseout="unhover(this)"
                         ></span>
                    <div class="btn-img-text">RESOLVED</div>
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" data-dismiss="alert" wott-snooze wott-snooze-duration="24">24 hours</a>
                    <a class="dropdown-item" href="#" data-dismiss="alert" wott-snooze wott-snooze-duration="24*7">7 days</a>
                  </div>
                </div>
              </div>
              {% endifnotequal %}
            </div>
            
            <section class="wott-open-box mb-4">
              <div class="wott-inner-open-box">
                <div class="open-box-header d-flex align-items-center justify-content-between">
                  <h4 class="mb-0 open-box-header-text">Affected Nodes:</h4>
                  <a href="#" class="wott-node">WOTT-1</a>
                  <a href="#" class="wott-node">WOTT-2</a>
                  <a href="#" class="wott-node">WOTT-3</a>
                  <a href="#" class="wott-node">WOTT-4</a>
                  <a href="#" class="wott-node">WOTT-5</a>
                  <button id="" class="btn wott-btn-header">VIEW ALL NODES +</button>
                </div>
                <!-- <p class="actions-safe">{{ action.html|safe }}</p> -->
                <p class="actions-safe">We found insecure configuration issue with OpenSSH on <a href="/devices/1/">artem-linux-gf</a>, <a href="/devices/9/">clone</a>: insecure parameter PermitRootLogin. To improve the security posture of your node, please consider changing PermitRootLogin to "no".</p>
                <p class="actions-safe">We found insecure configuration issue with OpenSSH on.</p>
                <div class="inner-open-box d-flex align-items-center">
                  <a href="#" class="nav-open-box">MANUAL</a>
                  <a href="#" class="nav-open-box2">ANSIBLE</a>
                </div>
                <div class="open-box-tab">
                  <p class="">Run the following command to bring your system up to date</p>
                  <div class="terminal-box">
                    <div class="terminal-header">
                      <h5>Terminal</h5>
                    </div>
                    <div class="terminal-body">
                      <div class="terminal-text">
                        <span class="terminal-instructions">$ dotnet add package Wott.io</span>
                        <span class="terminal-instructions">> dotnet restore</span>
                      </div>
                    </div>
                  </div>
                </div>
               
                <div class="line-box d-flex justify-content-between">
                  <a class="mb-0" href="{{ action.doc_url }}">Learn More</a>
                  <button class="wott-dropdown">
                    <i class="fas fa-sort-down"></i>
                  </button>
                </div>
                <div class="learn-more-box" style="display: none"> <!--@Artem: Change to display block-->
                  <h4>This is a fake title</h4>
                  <p>Mussum Ipsum, cacilds vidis litro abertis. Quem num gosta di mé, boa gentis num é. Interagi no mé, cursus quis, vehicula ac nisi. Casamentiss faiz malandris se pirulitá. Detraxit consequat et quo num tendi nada.
                    Praesent malesuada urna nisi, quis volutpat erat hendrerit non. Nam vulputate dapibus. Posuere libero varius. Nullam a nisl ut ante blandit hendrerit. Aenean sit amet nisi. Atirei o pau no gatis, per gatis num morreus. Tá deprimidis, eu conheço uma cachacis que pode alegrar sua vidis.
                    Aenean aliquam molestie leo, vitae iaculis nisl. Cevadis im ampola pa arma uma pindureta. A ordem dos tratores não altera o pão duris. In elementis mé pra quem é amistosis quis leo.
                    Admodum accumsan disputationi eu sit. Vide electram sadipscing et per. Interessantiss quisso pudia ce receita de bolis, mais bolis eu num gostis. Suco de cevadiss, é um leite divinis, qui tem lupuliz, matis, aguis e fermentis. Paisis, filhis, espiritis santis.</p>
                </div>
                
                
              </div>
            </section>

          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="recommendation-left-box bg-white p-5 mt-2 wott-box-shadow" style="display: none; margin-top: -1rem;" id="success-card">
    <div class="full-alert-box mb-3">
      <div class="alert-title">
        <h5 class="alert-title-big mb-0">Well Done!</h5>
      </div>
      <div class="alert-instruction-big mb-0">
        <p class="alert-instruction-big"><i class="align-middle mr-2" data-feather="check"></i>No recommended tasks.</p>
      </div>
    </div>
  </div>

<!--@Artem the modal is bellow, it needs all interactions to be implemented-->
<div id="all-nodes">
  <div class="popover-box wott-scroll-y" style="visibility: hidden; pointer-events: all; z-index: 999;"> <!--change style to visible to show this box-->
    <div class="wott-popover-header">
      <div class="wott-popover-header-box">
        <h1 class="mb-0" id="wott-popover-title">All Nodes</h1>
        <span id="close-popover-buttton"><img src="http://localhost:8003/media/close-icon.png" alt="close"></span>
      </div>
      <hr class="popover-title-line">
    </div>
    <div class="wott-popover-body w-100"> <!--HARDCODE BELLOW-->               
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
      <a class="wott-node-list wott-list-blue" href="/devices/1/cve/">artem-linux-gf</a>
    </div>
  </div>
</div>


  <style>

    .alert-title-big {
      font-size: 2rem;
      color: #2460c8;
    }

    .alert-instruction-big {
      font-size: 1.5rem;
      color: #9298a5;
      padding-top: 5px;;
    }

    .look-disable {
      filter: grayscale(100%);
      opacity: .5;
      pointer-events: none;
    }

    .wott-dropdown {
      background-color:  transparent;
      width: auto;
      padding :4px;
      border: 0;
    }

    .learn-more-box {
      background-color:#d9deee;
      margin: -2.5rem 5.5rem 2.5rem;
      padding: 2rem 2rem;
      font-size: .8rem;
      color:#495057;
    }

    .learn-more-box h4 {
      padding: 0.5rem 0 1rem;
    }


    /* MODAL */

   #all-nodes .popover-box {
      padding: 0;
      color: #495057;
      position: fixed;
      overflow: hidden;
      width: 800px;
      max-height: 510px;
      top: 22%;
      left: 0;
      right: 0;
      margin: auto;
      background-color: white;
      border-radius: 8px;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      visibility: hidden;
      pointer-events: all;
      z-index: 0;
      word-wrap: break-word;
    }

    #actions-tab .overlay {
      position: fixed;
      display: block;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(7, 26, 61, 0.7);
      z-index: 990;
    }



    #all-nodes .wott-popover-body {
      padding: 2.5rem 0rem 2rem 4rem;
      word-wrap: break-word;
    }

    #all-nodes .wott-popover-header {
      position: sticky !important;
      top: 0;
      left: 0;
      background-color: white;
      width: 100%;
    }

    #all-nodes .wott-popover-header-box {
      padding: 2.5rem 4rem 2rem;
      margin-bottom: 0 !important;
      display: flex;
      justify-content: space-between;
    }

    #all-nodes .wott-scroll-y {
      overflow-y: scroll;
    }

    #all-nodes .wott-scroll-x {
      overflow-x: scroll;
    }

    #all-nodes .wott-node-list {
      display: inline-block;
      width: 100px;
      white-space: normal;
      margin: 0;
      margin-bottom: 2rem;
      margin-right: 7%;
      min-width: 17%;
      max-width: 17%;
      font-size: .9rem;
      font-weight: 600;
    }

    #all-nodes .popover-title {
      width: 100%;
      padding: 0.5rem 2.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #all-nodes #wott-popover-title {
      font-weight: 600;
    }

    #all-nodes .popover-title-line {
      width: 100%;
      margin-left: 0;
    }

  </style>
{% endblock admin_content %}

{% block scripts %}
  {{ block.super }}
  <script>
   
    $('.wott-open-box').css("display", "none") // @Artem: change to block/none to see/hide the open box

    function hover(e) {
      let obj = document.getElementById(`${e.id}`);
      let src = obj.getAttribute("data-src2");
      e.setAttribute('src', src);
    }

    function unhover(e) {
      let obj = document.getElementById(`${e.id}`);
      let src = obj.getAttribute("data-src1");
      e.setAttribute('src', src);
    }



    /**
     * Snooze an action. Used by the close icon on the alerts.
     * @param id - action id
     * @param devices - list of device ids
     */
    function snoozeAction(id, devices, duration) {
      $.ajax({
          url: '/snooze-action/',
          type:"POST",
          data: JSON.stringify({
              action_id: id,
              device_ids: devices,
              duration: duration
          }),
          contentType: "application/json; charset=utf-8",
          dataType: "json"
      });
    }

    $(() => {
        $('[wott-snooze]').click((e) => {
            let button = $(e.target), parent = button.closest('[wott-action]');
            let id = eval(parent.attr('wott-action-id')),
                devices = eval(parent.attr('wott-action-devices')),
                duration = eval(button.attr('wott-snooze-duration')),
                snooze_type = duration? "Snooze":  button.text(),
                title = parent.attr('wott-action-title');
            console.log(id, devices, duration, snooze_type, title);
            snoozeAction(id, devices, duration);
          {% if MIXPANEL_TOKEN %}
            mixpanel.track("Snooze", {
                type: snooze_type,
                recommended_action: title,
                duration: (duration? duration: null),
                // TODO: affected service
            });
          {% endif %}
        })
    })
  </script>
  <script>
    // Listen to mutations to the DOM. If there are no alerts then show a message.
    var targetNode = document.getElementById( 'alert-container');
    var successNode = document.getElementById('success-card');
    var config = {
      childList: true
    };

    /**
     * Show the Success message.
     */
    function showSuccessCard() {
      successNode.style.display = 'block'
    }

    /**
     * Callback to count number of alerts on page and display success message.
     */
    function countAlerts() {
      var alertCount = targetNode.childElementCount;
      if (alertCount === 0) {
        showSuccessCard()
      }
    }

    var observer = new MutationObserver(countAlerts);
    observer.observe(targetNode, config);
    // Initial count on load
    countAlerts();

  
  </script>
{% endblock scripts %}
