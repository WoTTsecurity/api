{% extends "admin_base.html" %}

{% block title %}WoTT - Recommended Actions{% endblock title %}

{% block dashboard_title %}
  <h1>Recommended Actions{% if device_name %} for {{ device_name }}{% endif %}</h1>
{% endblock dashboard_title %}

{% block admin_content %}
  <div class="row">
    <div class="mb-3 mt-3 w-100" id="alert-container">
      {% for action in actions %}
        <div class="alert alert-primary alert-outline alert-dismissible alert-recommended" role="alert">
          <div class="close" style="opacity: initial">
            <span class="badge badge-{{ action.severity.1 }} font-weight-light wott-alert-severity">
              Severity: {{ action.severity.0 }}
            </span>
          </div>
          <div class="alert-message">
            <h3 class="alert-heading">
              {{ action.title|safe }}
              {% if action.issue_url %}
                <a href="{{ action.issue_url }}"><i class="fab fa-github"></i></a>
              {% endif %}
            </h3>
            <p>{{ action.description|safe }}</p>

            <span><a class="mb-0" href="{{ action.doc_url }}">Learn More</a></span>
            {% ifnotequal action.action_id 0 %}
            {% with action_id=action.action_id action_devices=action.devices %}
            <div class="btn-group float-right wott-alert-btn-group"
                 wott-action wott-action-id="{{ action_id }}" wott-action-devices="{{ action_devices }}" wott-action-title="{{ action.title }}">
              <button type="button" class="btn btn-success mr-1" data-dismiss="alert" wott-snooze wott-snooze-duration="null">Resolve</button>
              <button type="button" class="btn btn-danger mr-1" data-dismiss="alert" wott-snooze wott-snooze-duration="0">Ignore</button>
              <button type="button" class="btn btn-secondary mr-1 dropdown-toggle" data-toggle="dropdown">Snooze</button>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="#" data-dismiss="alert" wott-snooze wott-snooze-duration="24">24 hours</a>
                <a class="dropdown-item" href="#" data-dismiss="alert" wott-snooze wott-snooze-duration="24*7">7 days</a>
              </div>
            </div>
            {% endwith %}
            {% endifnotequal %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="row" style="display: none; margin-top: -1rem;" id="success-card">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Well Done!</h5>
      </div>
      <div class="card-body">
        <p><i class="align-middle mr-2" data-feather="check"></i>No recommended tasks.</p>
      </div>
    </div>
  </div>
{% endblock admin_content %}

{% block scripts %}
  {{ block.super }}
  <style>
  .wott-alert-severity {
    font-size: small;
    color: black;
    text-shadow: none;
  }
  .wott-alert-btn-group button {
    font-size: small;
  }
  </style>
  <script>

    /**
     * Snooze an action. Used by the close icon on the alerts.
     * @param id - action id
     * @param devices - list of device ids
     */
    function snoozeAction(id, devices, duration) {
      $.ajax({
          url: '/snooze-action/',
          type:"POST",
          data: JSON.stringify({
              action_id: id,
              device_ids: devices,
              duration: duration
          }),
          contentType: "application/json; charset=utf-8",
          dataType: "json"
      });
    }

    $(() => {
        $('[wott-snooze]').click((e) => {
            let button = $(e.target), parent = button.closest('[wott-action]');
            let id = eval(parent.attr('wott-action-id')),
                devices = eval(parent.attr('wott-action-devices')),
                duration = eval(button.attr('wott-snooze-duration')),
                snooze_type = duration? "Snooze":  button.text(),
                title = parent.attr('wott-action-title');
            console.log(id, devices, duration, snooze_type, title);
            snoozeAction(id, devices, duration);
          {% if MIXPANEL_TOKEN %}
            mixpanel.track("Snooze", {
                type: snooze_type,
                recommended_action: title,
                duration: (duration? duration: null),
                // TODO: affected service
            });
          {% endif %}
        })
    })
  </script>
  <script>
    // Listen to mutations to the DOM. If there are no alerts then show a message.
    var targetNode = document.getElementById( 'alert-container');
    var successNode = document.getElementById('success-card');
    var config = {
      childList: true
    };

    /**
     * Show the Success message.
     */
    function showSuccessCard() {
      successNode.style.display = 'block'
    }

    /**
     * Callback to count number of alerts on page and display success message.
     */
    function countAlerts() {
      var alertCount = targetNode.childElementCount;
      if (alertCount === 0) {
        showSuccessCard()
      }
    }

    var observer = new MutationObserver(countAlerts);
    observer.observe(targetNode, config);
    // Initial count on load
    countAlerts();
  </script>
{% endblock scripts %}

