{% extends "admin_base.html" %}

{% block title %}WoTT - Recommended Actions{% endblock title %}

{% load static %}

{% block dashboard_title %}
  <h1>Recommended Actions{% if device_name %} for {{ device_name }}{% endif %}</h1>
{% endblock dashboard_title %}

{% block admin_content %}
  <div id="actions-tab" class="">
    <div class="mb-3 w-100" id="alert-container">
      {% for action in actions %}
        <div class="wott-action" role="alert" wott-action-id="{{ action.action_id }}">
          <div class="full-alert-box mb-3 wott-box-shadow">
            
            <div class="d-flex wott-closed-box align-items-center">
              <div class="recommendation-left-box">
                <div class="round pl-5">
                  <input type="checkbox" id="alert-ra-{{forloop.counter}}"/> <!--include checked atribute to check the input-->
                  <label for="alert-ra-{{forloop.counter}}"></label>
                </div>
                <div class="alert-box-text">
                  <div class="d-flex align-items-center mb-0">
                    <span class="alert-title"> <!--include solved-dash to linetrough the title-->
                      {{ action.title|safe }}
                      
                      {% if action.issue_url %}
                        <a href="{{ action.issue_url }}"><i class="fab fa-github"></i></a>
                      {% endif %}
                    </span>
                    {% with action.severity.value as action_severity %}
                    <div class="badge mr-4 mb-1 text-uppercase wott-rect-badge-{{ action_severity.1 }}">
                      {{ action_severity.0 }}
                    </div>
                    {% endwith %}
                  </div>
                  <h5 class="alert-instruction mb-0">{{ action.subtitle }}</h5>
                </div>
              
                
                <div class="dropdown">
                  <button id="toogle-ra" wott-action-id="{{ action.action_id }}" class="btn wott-btn-dropdown toggle-ra-button">
                    VIEW DETAILS
                    <i class=" ml-1 fas fa-sort-down"></i>
                  </button>
                </div>
              </div>
              
            {% if action.action_id > 0 %}
              <div class="btn-group-box">
                <div class="btn-group wott-alert-btn-group"
                    wott-action
                    wott-action-id="{{ action.action_id }}"
                    wott-action-devices="[{% for d in action.devices %}{{ d.pk }},{% endfor %}]"
                    wott-action-title="{{ action.title }}">
                  <button type="button" class="bg-white mr-4" data-dismiss="alert"
                          wott-snooze wott-snooze-duration="0" wott-snooze-type="Ignore">
                    <span><img src="{% static '/media/ignore-icon.png' %}"></span>
                    <div class="btn-img-text">IGNORE</div>
                  </button>
                  <button type="button" class="bg-white mr-4" data-toggle="dropdown">
                    <span><img src="{% static '/media/snooze-icon.png' %}"></span>
                    <div class="btn-img-text">SNOOZE</div>
                  </button>
                  <button type="button" class="bg-white" data-dismiss="alert"
                          wott-snooze wott-snooze-duration="null" wott-snooze-type="Resolve">
                    <span id="close-btn"><img src="{% static '/media/resolve-icon.png' %}"></span>
                    <div class="btn-img-text">RESOLVED</div>
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" data-dismiss="alert"
                       wott-snooze wott-snooze-duration="24" wott-snooze-type="Snooze">24 hours</a>
                    <a class="dropdown-item" href="#" data-dismiss="alert"
                       wott-snooze wott-snooze-duration="24*7" wott-snooze-type="Snooze">7 days</a>
                  </div>
                </div>
              </div>
            {% endif %}
            </div>
            
            <section wott-action-id="{{ action.action_id }}" wott-action-expanded=false class="wott-open-box mb-4 d-none">
              <div class="wott-inner-open-box">
                <div class="open-box-header d-flex align-items-center justify-content-between">
                {% if action.action_id > 0 %}
                  <h4 class="mb-0 open-box-header-text">Affected Nodes:</h4>
                  {% for d in action.devices %}
                    <a href="{% url 'device-detail' d.pk %}" class="wott-node">{{ d.get_name }}</a>
                  {% endfor %}
                  <button wott-action-id="{{ action.action_id }}" class="btn wott-btn-header">
                    VIEW ALL NODES +
                    <template>
                    {% for d in action.devices %}
                      <a href="{% url 'device-detail' d.pk %}" class="wott-node">{{ d.get_name }}</a>
                    {% endfor %}
                    </template>
                  </button>
                {% endif %}
                </div>
                {{ action.short_html|safe }}

                {% if action.terminal_title %}
                <div class="inner-open-box d-flex align-items-center">
                  <a href="#" class="nav-open-box">MANUAL</a>
                  <a href="#" class="nav-open-box2">ANSIBLE</a>
                </div>
                <div class="open-box-tab">
                  <p class="terminal-title">{{ action.terminal_title }}</p>
                  <div class="terminal-box">
                    <div class="terminal-header">
                      <h5>Terminal</h5>
                    </div>
                    <div class="terminal-body">
                      <div class="terminal-text">
                        <span class="terminal-instructions">{{ action.terminal_code|linebreaksbr }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
               
                <h4 class="line-box"><a class="mb-0" href="{{ action.doc_url }}">Learn More</a></h4>
                <div class="wott-inner-open-box">
                  {{ action.long_html|safe }}
                </div>
                
                
              </div>
            </section>

          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="row" style="display: none; margin-top: -1rem;" id="success-card">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Well Done!</h5>
      </div>
      <div class="card-body">
        <p><i class="align-middle mr-2" data-feather="check"></i>No recommended tasks.</p>
      </div>
    </div>
  </div>
{% endblock admin_content %}

{% block scripts %}
  {{ block.super }}
  <script>
   
    $('.toggle-ra-button').click((e) => {
        let action_id = $(e.target).attr('wott-action-id'),
            block = $(`.wott-open-box[wott-action-id=${action_id}]`),
            expanded = block.attr('wott-action-expanded') === 'true';

        console.log(action_id);
        block.toggleClass("d-none", expanded);
        block.toggleClass("d-block", !expanded);
        block.attr('wott-action-expanded', !expanded);
    });

    $('.wott-btn-header').click((e) => {
        let btn = $(e.target);
        let action_id = btn.attr('wott-action-id');
        console.log(action_id, btn.children('template').html());
    });

    function viewNodes(id) {

    }

    /**
     * Snooze an action. Used by the close icon on the alerts.
     * @param id - action id
     * @param devices - list of device ids
     */
    function snoozeAction(id, devices, duration) {
      $.ajax({
          url: '/snooze-action/',
          type:"POST",
          data: JSON.stringify({
              action_id: id,
              device_ids: devices,
              duration: duration
          }),
          contentType: "application/json; charset=utf-8",
          success: () => {
            $(`.wott-action[wott-action-id=${id}]`).toggleClass('d-none')
          }
      });
    }

    $(() => {
        $('[wott-snooze]').click((e) => {
            let button = $(e.target).closest('[wott-snooze-duration]'), parent = button.closest('[wott-action]');
            let id = eval(parent.attr('wott-action-id')),
                devices = eval(parent.attr('wott-action-devices')),
                duration = eval(button.attr('wott-snooze-duration')),
                snooze_type = button.attr('wott-snooze-type'),
                title = parent.attr('wott-action-title');
            console.log(id, devices, duration, snooze_type, title);
            snoozeAction(id, devices, duration);
          {% if MIXPANEL_TOKEN %}
            mixpanel.track("Snooze", {
                type: snooze_type,
                recommended_action: title,
                duration: (duration? duration: null),
                // TODO: affected service
            });
          {% endif %}
        })
    })
  </script>
  <script>
    // Listen to mutations to the DOM. If there are no alerts then show a message.
    var targetNode = document.getElementById( 'alert-container');
    var successNode = document.getElementById('success-card');
    var config = {
      childList: true
    };

    /**
     * Show the Success message.
     */
    function showSuccessCard() {
      successNode.style.display = 'block'
    }

    /**
     * Callback to count number of alerts on page and display success message.
     */
    function countAlerts() {
      var alertCount = targetNode.childElementCount;
      if (alertCount === 0) {
        showSuccessCard()
      }
    }

    var observer = new MutationObserver(countAlerts);
    observer.observe(targetNode, config);
    // Initial count on load
    countAlerts();

  
  </script>
{% endblock scripts %}
