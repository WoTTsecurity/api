{% extends "admin_base.html" %}

{% block css %}
    {{ form_media.css }}
{% endblock %}
{% block js %}
    {{ form_media.js }}
{% endblock %}

{% block title %}WoTT - Credentials{% endblock title %}

{% block dashboard_title %}
  <h1>Pairing Keys</h1>
{% endblock dashboard_title %}

{% block admin_content %}
  <form>
  <div class="modal" tabindex="-1" role="dialog" id="wott-confirm-modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirm-title">Confirm delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="confirm-msg">Are you sure want to delete this key?</p>
        </div>
        <div class="alert alert-warning wott-form-alert p-1" role="alert" id="confirm-alert">
          Server error
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="confirm-btn">Yes</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  </form>

  <form method="POST" action="" id="pairing-keys-form">
    <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Pairing Keys</h5>
              <h6 class="card-subtitle text-muted">List of keys not yet applied.</h6>
            </div>
            <div class="card-body">
              <table id="datatables-basic" class="table table-striped table-responsive-xs" style="width:100%">
                <thead>
                <tr>
                  <th>Created</th>
                  <th>Key</th>
                  <th></th>
                </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
    </div>
{#  <div class="row">#}
    {% csrf_token %}
    <button type="submit" class="btn btn-success" id="create-new-btn">ï¼‹ Create Pairing Key</button>
{#  </div>#}
  </form>
{% endblock admin_content %}

{% block scripts %}
  <style>
  .btn {
    color: white;
  }
  .wott-form-alert {
    color: black;
    display: none;
  }
  td.wott-cred-btns .btn {
    visibility: hidden;
  }
  #datatables-basic tr:hover td.wott-cred-btns .btn {
    visibility: visible;
  }
  </style>
  <script>

    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $(document).ready(function(){
      $('[data-toggle="popover"]').popover({
          trigger: "hover"
      });
    });

    var table;
    document.addEventListener("DOMContentLoaded", function () {
      // Datatables basic
      table = $('#datatables-basic').DataTable({
        responsive: true,
        data: {{ data | safe }},
        columns: [
            { data: 'created', sorting: true },
            { data: 'key', sorting: false },
        ],
        columnDefs: [ {
          targets: 2,
          orderable: false,
          data: null,
          className: 'wott-cred-btns',
          render: render_buttons,
        }],
        language: {
          emptyTable: "No key created."
        },
        rowId: 'key',
      });
    });

    function fa_button( type, btn, fa, onclick, popover=undefined)
    {
        let pop = ( popover === undefined ) ? "" : ' data-toggle="popover" data-placement="top" title="' +
            popover.title + (popover.content === undefined ? '"' : ('" data-content="' +  popover.content + '"'));

        return '<button type="' + type + '" class="btn ' + btn + '" aria-label="Left Align"><span class="'
              + fa + '" aria-hidden="true" onclick="' + onclick + '"' + pop + '></span></button>';
    }

    function render_buttons(data, type, row, meta){
        let save_url = "location.href='{{ request.path }}?pk=" + row.key + ";'";

        return fa_button( "button", "btn-primary", "fas fa-copy fa-lg", "copy_key('" + row.key + "')",
                {
                    title: "Copy key to clipboard",
                    content: "Copy the enrollment string to the clipboard. The string is in the form 'key = value' " +
                             "to simply paste to config.ini file"
                })
            + fa_button( "button", "btn-success", "fas fa-save fa-lg", save_url,
                { title:"Store key to disk", content: "Store generated enrollment key as ready to go config.ini file" } )
            + fa_button( "button", "btn-danger", "fas fa-trash fa-lg", "revoke_key(this)",
                { title:"Revoke the enrollment key"} )
    }

    function revoke_key(a){


      $('#confirm-btn').on("click", {key: a.parentElement.parentElement.parentElement.id}, delete_key );
      show_dialog("Confirm Revoke Key",
          "Are you sure you want to revoke?",
          "Revoke"
      );
    }

    function copy_key(a){
        copyToClipboard(
            "enroll_token = " + a
        );
    }

    /***
     *  on confirm delete
     *  @param e - e.data.key <- key to delete
     */
    function delete_key(e){
        $.ajax({
            url: '{{ request.path }}',
            type: "DELETE",
            data: JSON.stringify({ key: e.data.key }),
            contentType: 'application/json',
        }).done(function () {
            console.log('success');
            location.href='{{ request.path }}'
        }).fail(function (a) {
            console.log('error');
            console.log(a.status, a.responseText);
            alertbox_on_ajax_fail(a, "confirm-alert");
        });
    }


    /***
     *  setup dialog parameters and toggle on
     *  @param title - dialog title
     *  @param message - dialog message
     *  @param btn_text - dialog confirm button text
     */
    function show_dialog(title, message, btn_text )
    {
        $('#confirm-title')[0].innerText = title;
        $('#confirm-msg')[0].innerText = message;
        $('#confirm-btn')[0].innerText = btn_text;
        $('#confirm-alert')[0].style.display = 'none';
        $('#wott-confirm-modal').modal('toggle');
    }

    /**
     * show alert msg
     * @param messages  - array of error messages
     * @param alert_box_id - html element id of message placeholder
     */
    function wott_alert_strings(messages, alert_box_id){
        let alertbox = $("#"+alert_box_id)[0];
        alertbox.style.display = 'block';
        alertbox.innerText = messages.join("\n");
        return;
    }

    function alertbox_on_ajax_fail(a, alert_box_id){
        console.log('error');
        console.log(a.status, a.responseText);

        errMsgs = []
        if(a.status == 400 || a.status == 404 || a.status == 405) {
            errMsg = "";
            firstFailed = "";
            for (key in a.responseJSON) {
                errMsgss.push( key + " : " + a.responseJSON[key] );
            }
        }
        else errMsgs.push(a.responseText);
        wott_alert_strings(errMsgs, alert_box_id);
    }

    const copyToClipboard = str => {
        const el = document.createElement('textarea');  // Create a <textarea> element
        el.value = str;                                 // Set its value to the string that you want copied
        el.setAttribute('readonly', '');                // Make it readonly to be tamper-proof
        el.style.position = 'absolute';
        el.style.left = '-9999px';                      // Move outside the screen to make it invisible
        document.body.appendChild(el);                  // Append the <textarea> element to the HTML document
        const selected =
          document.getSelection().rangeCount > 0        // Check if there is any content selected previously
            ? document.getSelection().getRangeAt(0)     // Store selection if found
            : false;                                    // Mark as false to know no selection existed before
        el.select();                                    // Select the <textarea> content
        document.execCommand('copy');                   // Copy - only works as a result of a user action (e.g. click events)
        document.body.removeChild(el);                  // Remove the <textarea> element
        if (selected) {                                 // If a selection existed before copying
            document.getSelection().removeAllRanges();  // Unselect everything on the HTML document
            document.getSelection().addRange(selected); // Restore the original selection
        }
    };

  </script>
{% endblock scripts %}